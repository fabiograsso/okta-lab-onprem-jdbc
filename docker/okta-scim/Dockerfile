FROM --platform=linux/amd64 quay.io/centos/centos:stream9-minimal

LABEL maintainer="Fabio Gasso <fabio.grasso@okta.com>"
LABEL org.opencontainers.image.authors="Fabio Gasso <fabio.grasso@okta.com>"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.licenses="Apache-2.0"
LABEL org.opencontainers.image.source="https://github.com/fabiograsso/okta-lab-radius"
LABEL org.opencontainers.image.description=" "

ARG OKTA_EULA_ACCEPT=true

COPY packages/ /packages/

# Install necessary packages and update CA certificates if custom certificates are provided
RUN \
    shopt -s nullglob nocaseglob && \
    for cert in /packages/*.pem /packages/*.crt; do \
        if [ -f "$cert" ]; then \
            echo "ðŸ” Custom certificate found: $(basename "$cert"), updating CA trust..." && \
            cp -f "$cert" /etc/pki/ca-trust/source/anchors/ && \
            update-ca-trust && \
            echo "âœ… CA trust updated successfully." || { \
                echo "âŒ Failed to update CA trust with $cert"; \
                exit 1; \
            }; \
        fi; \
    done && \
    microdnf install -y ca-certificates libXt openssl hostname procps && \
    curl https://download.oracle.com/java/21/archive/jdk-21.0.9_linux-x64_bin.rpm -o /packages/jdk-21.0.9_linux-x64_bin.rpm && \
    rpm -ivh /packages/jdk-21.0.9_linux-x64_bin.rpm && \
    rm -rf /packages/jdk-*.rpm && \
    microdnf clean all && \
    find /var/cache/yum -type f -delete

# Install Okta SCIM Server
RUN CUSTOMER_ID=${CUSTOMER_ID} rpm -Uvh /packages/OktaOnPremScimServer*.rpm && \
    # Clean the configuration generated by the setup script in the RPM %post scriptlet, as we'll generate it at runtime in the entrypoint script based on the environment variables and mounted certificates
    rm -rf /etc/OktaOnPremScimServer/* && \
    rm -rf /var/log/OktaOnPremScimServer/*  && \
    rm -rf /etc/pki/tls/certs/OktaOnPremScimServer-${CUSTOMER_ID}.crt && \
    rm -rf /etc/pki/tls/private/OktaOnPremScimServer-${CUSTOMER_ID}.key && \
    rm -rf /etc/pki/tls/private/OktaOnPremScimServer-${CUSTOMER_ID}.p12 && \
    rm -rf /etc/pki/tls/private/OktaOnPremScimServer-${CUSTOMER_ID}.p12.pass    

COPY entrypoint.sh /usr/local/bin/entrypoint.sh
COPY packages/*.jar /opt/OktaOnPremScimServer/userlib/

RUN chmod +x /usr/local/bin/entrypoint.sh && \
        rm -rf /packages/

ENTRYPOINT [ "/usr/local/bin/entrypoint.sh" ]

HEALTHCHECK --start-period=5s \
  CMD TOKEN=$(grep 'scim.security.bearer.token' /etc/OktaOnPremScimServer/config-*.properties 2>/dev/null | cut -d'=' -f2 | tr -d ' ') && \
      [ -n "$TOKEN" ] && \
      curl --cacert /etc/pki/tls/certs/OktaOnPremScimServer-*.crt -s -f --no-keepalive --max-time 5 -H "Authorization: Bearer $TOKEN" https://localhost:1443/ws/rest/jdbc_on_prem/scim/v2/Status 2>/dev/null | grep -q 'Scim Server is running' || exit 1
